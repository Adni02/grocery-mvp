{% extends "base.html" %}

{% block title %}{{ 'Rediger adresse' if address else 'Ny adresse' }} | {{ app_name }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="addressForm()">
    <!-- Header -->
    <div class="mb-8">
        <a href="/profile" class="text-sm text-primary-600 hover:text-primary-700 flex items-center mb-2">
            <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Tilbage til profil
        </a>
        <h1 class="text-2xl font-bold text-gray-900">
            {{ 'Rediger adresse' if address else 'Ny adresse' }}
        </h1>
    </div>
    
    <div class="bg-white rounded-lg shadow-sm p-6">
        <form @submit.prevent="submitForm">
            <!-- Step 1: Postcode Verification -->
            <div x-show="step === 1" class="space-y-6">
                <div>
                    <label for="postcode" class="block text-sm font-medium text-gray-700 mb-1">
                        Postnummer
                    </label>
                    <div class="flex space-x-3">
                        <input type="text" 
                               id="postcode"
                               x-model="form.postcode"
                               maxlength="4"
                               pattern="\d{4}"
                               placeholder="F.eks. 2100"
                               class="flex-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500"
                               :disabled="isVerifying || postcodeVerified">
                        
                        <button type="button"
                                @click="verifyPostcode"
                                :disabled="form.postcode.length !== 4 || isVerifying || postcodeVerified"
                                class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!isVerifying && !postcodeVerified">Bekræft</span>
                            <span x-show="isVerifying">Checker...</span>
                            <span x-show="postcodeVerified" class="flex items-center">
                                <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Bekræftet
                            </span>
                        </button>
                    </div>
                    
                    <!-- Error message -->
                    <p x-show="postcodeError" x-text="postcodeError" class="mt-2 text-sm text-red-600"></p>
                    
                    <!-- Success message -->
                    <p x-show="postcodeVerified && verifiedCity" class="mt-2 text-sm text-green-600">
                        ✓ Vi leverer til <span x-text="verifiedCity"></span>
                    </p>
                </div>
                
                <div class="text-sm text-gray-500">
                    <p>Vi leverer pt. kun til udvalgte postnumre i Københavnsområdet.</p>
                </div>
            </div>
            
            <!-- Step 2: Full Address Form -->
            <div x-show="step === 2" class="space-y-6">
                <!-- Label -->
                <div>
                    <label for="label" class="block text-sm font-medium text-gray-700 mb-1">
                        Betegnelse
                    </label>
                    <input type="text" 
                           id="label"
                           x-model="form.label"
                           placeholder="F.eks. Hjem, Arbejde"
                           required
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <!-- Street + Building -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label for="street" class="block text-sm font-medium text-gray-700 mb-1">
                            Vejnavn og husnummer
                        </label>
                        <input type="text" 
                               id="street"
                               x-model="form.street"
                               placeholder="F.eks. Østerbrogade 123"
                               required
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label for="building" class="block text-sm font-medium text-gray-700 mb-1">
                            Bygning
                        </label>
                        <input type="text" 
                               id="building"
                               x-model="form.building"
                               placeholder="F.eks. B"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                
                <!-- Floor + Apartment -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="floor" class="block text-sm font-medium text-gray-700 mb-1">
                            Etage
                        </label>
                        <input type="text" 
                               id="floor"
                               x-model="form.floor"
                               placeholder="F.eks. 2"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label for="apartment" class="block text-sm font-medium text-gray-700 mb-1">
                            Lejlighed
                        </label>
                        <input type="text" 
                               id="apartment"
                               x-model="form.apartment"
                               placeholder="F.eks. th"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                
                <!-- Postcode + City (readonly) -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="postcode_display" class="block text-sm font-medium text-gray-700 mb-1">
                            Postnummer
                        </label>
                        <input type="text" 
                               id="postcode_display"
                               :value="form.postcode"
                               readonly
                               class="block w-full rounded-lg bg-gray-100 border-gray-300 text-gray-500">
                    </div>
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-1">
                            By
                        </label>
                        <input type="text" 
                               id="city"
                               x-model="form.city"
                               readonly
                               class="block w-full rounded-lg bg-gray-100 border-gray-300 text-gray-500">
                    </div>
                </div>
                
                <!-- Delivery Instructions -->
                <div>
                    <label for="instructions" class="block text-sm font-medium text-gray-700 mb-1">
                        Leveringsinstruktioner (valgfrit)
                    </label>
                    <textarea id="instructions"
                              x-model="form.instructions"
                              rows="3"
                              placeholder="F.eks. Ring på dørtelefonen, kode 1234..."
                              class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
                
                <!-- Default Address -->
                <div class="flex items-center">
                    <input type="checkbox" 
                           id="is_default"
                           x-model="form.is_default"
                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                    <label for="is_default" class="ml-2 text-sm text-gray-700">
                        Gør denne til min standardadresse
                    </label>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="mt-6 flex justify-between">
                <div>
                    <button type="button"
                            x-show="step === 2"
                            @click="step = 1; postcodeVerified = false"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Skift postnummer
                    </button>
                </div>
                
                <div class="flex space-x-3">
                    <a href="/profile"
                       class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Annuller
                    </a>
                    
                    <button type="submit"
                            x-show="step === 2"
                            :disabled="isSubmitting"
                            class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50">
                        <span x-show="!isSubmitting">{{ 'Gem ændringer' if address else 'Gem adresse' }}</span>
                        <span x-show="isSubmitting">Gemmer...</span>
                    </button>
                </div>
            </div>
            
            <!-- Error message -->
            <p x-show="submitError" x-text="submitError" class="mt-4 text-sm text-red-600 text-center"></p>
        </form>
    </div>
</div>

<script>
function addressForm() {
    return {
        step: {{ 2 if address else 1 }},
        postcodeVerified: {{ 'true' if address else 'false' }},
        verifiedCity: '{{ address.city if address else "" }}',
        postcodeError: '',
        isVerifying: false,
        isSubmitting: false,
        submitError: '',
        
        form: {
            label: '{{ address.label if address else "" }}',
            postcode: '{{ address.postcode if address else "" }}',
            city: '{{ address.city if address else "" }}',
            street: '{{ address.street if address else "" }}',
            building: '{{ address.building if address else "" }}',
            floor: '{{ address.floor if address else "" }}',
            apartment: '{{ address.apartment if address else "" }}',
            instructions: '{{ address.instructions if address else "" }}',
            is_default: {{ 'true' if address and address.is_default else 'false' }}
        },
        
        async verifyPostcode() {
            this.isVerifying = true;
            this.postcodeError = '';
            
            try {
                const response = await fetch('/api/addresses/verify-postcode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ postcode: this.form.postcode })
                });
                
                const data = await response.json();
                
                if (response.ok && data.serviceable) {
                    this.postcodeVerified = true;
                    this.form.city = data.city;
                    this.verifiedCity = data.city;
                    
                    // Wait a moment then move to step 2
                    setTimeout(() => {
                        this.step = 2;
                    }, 500);
                } else {
                    this.postcodeError = 'Vi leverer desværre ikke til dette postnummer endnu.';
                }
            } catch (error) {
                console.error('Error:', error);
                this.postcodeError = 'Der skete en fejl. Prøv igen.';
            } finally {
                this.isVerifying = false;
            }
        },
        
        async submitForm() {
            this.isSubmitting = true;
            this.submitError = '';
            
            try {
                const addressId = '{{ address.id if address else "" }}';
                const url = addressId ? `/api/addresses/${addressId}` : '/api/addresses';
                const method = addressId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.form)
                });
                
                if (response.ok) {
                    window.location.href = '/profile';
                } else {
                    const data = await response.json();
                    this.submitError = data.detail || 'Kunne ikke gemme adresse';
                }
            } catch (error) {
                console.error('Error:', error);
                this.submitError = 'Der skete en fejl. Prøv igen.';
            } finally {
                this.isSubmitting = false;
            }
        }
    };
}
</script>
{% endblock %}
