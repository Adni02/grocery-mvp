{% extends "base.html" %}

{% block title %}Log ind | {{ app_name }}{% endblock %}

{% block content %}
<div class="min-h-[70vh] flex items-center justify-center px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">Velkommen tilbage</h1>
            <p class="mt-2 text-gray-600">Log ind på din konto for at fortsætte</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-8" x-data="loginPage()">
            <!-- Firebase Auth Container -->
            <div id="firebaseui-auth-container"></div>
            
            <!-- Or Divider -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-200"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-4 bg-white text-gray-500">eller</span>
                </div>
            </div>
            
            <!-- Phone Login -->
            <div x-show="!codeSent">
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                    Telefonnummer
                </label>
                <div class="flex space-x-2">
                    <div class="flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-lg">
                        <span class="text-gray-500">+45</span>
                    </div>
                    <input type="tel" 
                           id="phone"
                           x-model="phone"
                           placeholder="12 34 56 78"
                           maxlength="11"
                           class="flex-1 block w-full rounded-r-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <button @click="sendCode"
                        :disabled="phone.length < 8 || isSending"
                        class="mt-4 w-full py-3 px-4 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <span x-show="!isSending">Send kode via SMS</span>
                    <span x-show="isSending">Sender...</span>
                </button>
                
                <p x-show="phoneError" x-text="phoneError" class="mt-2 text-sm text-red-600"></p>
            </div>
            
            <!-- Verification Code Input -->
            <div x-show="codeSent">
                <p class="text-sm text-gray-600 mb-4">
                    Vi har sendt en kode til <strong x-text="'+45 ' + phone"></strong>
                </p>
                
                <label for="code" class="block text-sm font-medium text-gray-700 mb-1">
                    Bekræftelseskode
                </label>
                <input type="text" 
                       id="code"
                       x-model="code"
                       placeholder="123456"
                       maxlength="6"
                       class="block w-full rounded-lg border-gray-300 shadow-sm focus:ring-primary-500 focus:border-primary-500 text-center text-2xl tracking-widest">
                
                <button @click="verifyCode"
                        :disabled="code.length !== 6 || isVerifying"
                        class="mt-4 w-full py-3 px-4 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <span x-show="!isVerifying">Bekræft kode</span>
                    <span x-show="isVerifying">Bekræfter...</span>
                </button>
                
                <button @click="codeSent = false; code = ''"
                        class="mt-3 w-full text-sm text-gray-500 hover:text-gray-700">
                    ← Brug et andet nummer
                </button>
                
                <p x-show="codeError" x-text="codeError" class="mt-2 text-sm text-red-600"></p>
            </div>
            
            <!-- Dev Mode Note -->
            {% if config.DEV_MODE %}
            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">
                    <strong>Dev Mode:</strong> For at teste uden Firebase, brug token format:
                    <code class="bg-yellow-100 px-1 rounded">dev_email:test@example.com</code> eller
                    <code class="bg-yellow-100 px-1 rounded">dev_phone:+4512345678</code>
                </p>
            </div>
            {% endif %}
        </div>
        
        <p class="text-center text-sm text-gray-500">
            Ved at logge ind accepterer du vores 
            <a href="/terms" class="text-primary-600 hover:underline">Vilkår</a> og 
            <a href="/privacy" class="text-primary-600 hover:underline">Privatlivspolitik</a>.
        </p>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css">

<script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyAMrRL7bahOyCL2GRGGlBwtybHIdXcsKyo",
    authDomain: "grocery-mvp-db07d.firebaseapp.com",
    projectId: "grocery-mvp-db07d",
    storageBucket: "grocery-mvp-db07d.firebasestorage.app",
    messagingSenderId: "32996842593",
    appId: "1:32996842593:web:542a0c0260f50c146ade20"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Configure FirebaseUI
const uiConfig = {
    signInOptions: [
        firebase.auth.EmailAuthProvider.PROVIDER_ID,
        {
            provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            customParameters: {
                prompt: 'select_account'
            }
        }
    ],
    signInFlow: 'popup',
    callbacks: {
        signInSuccessWithAuthResult: function(authResult, redirectUrl) {
            // Get Firebase ID token and send to backend
            authResult.user.getIdToken().then(function(idToken) {
                verifyWithBackend(idToken);
            });
            return false; // Don't redirect automatically
        }
    }
};

// Start FirebaseUI
const ui = new firebaseui.auth.AuthUI(firebase.auth());
ui.start('#firebaseui-auth-container', uiConfig);

async function verifyWithBackend(idToken) {
    try {
        const response = await fetch('/api/auth/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: idToken })
        });
        
        if (response.ok) {
            const params = new URLSearchParams(window.location.search);
            const redirect = params.get('next') || '/';
            window.location.href = redirect;
        } else {
            const data = await response.json();
            alert(data.detail || 'Login failed');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Der skete en fejl');
    }
}

function loginPage() {
    return {
        phone: '',
        code: '',
        codeSent: false,
        isSending: false,
        isVerifying: false,
        phoneError: '',
        codeError: '',
        confirmationResult: null,
        
        async sendCode() {
            this.isSending = true;
            this.phoneError = '';
            
            try {
                const phoneNumber = '+45' + this.phone.replace(/\s/g, '');
                
                // Use invisible reCAPTCHA
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('phone', {
                        size: 'invisible'
                    });
                }
                
                this.confirmationResult = await firebase.auth().signInWithPhoneNumber(
                    phoneNumber, 
                    window.recaptchaVerifier
                );
                this.codeSent = true;
            } catch (error) {
                console.error('Error:', error);
                this.phoneError = 'Kunne ikke sende SMS. Prøv igen.';
            } finally {
                this.isSending = false;
            }
        },
        
        async verifyCode() {
            this.isVerifying = true;
            this.codeError = '';
            
            try {
                const result = await this.confirmationResult.confirm(this.code);
                const idToken = await result.user.getIdToken();
                await verifyWithBackend(idToken);
            } catch (error) {
                console.error('Error:', error);
                this.codeError = 'Forkert kode. Prøv igen.';
            } finally {
                this.isVerifying = false;
            }
        }
    };
}
</script>
{% endblock %}
