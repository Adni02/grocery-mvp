<!DOCTYPE html>
<html lang="da" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="h-full bg-gray-50" x-data="appState()" x-init="init()">
    <!-- Header -->
    {% include "components/header.html" %}
    
    <!-- Flash Messages -->
    <div x-show="flash.message" x-cloak
         class="fixed top-20 right-4 z-50 max-w-md"
         x-transition:enter="transition ease-out duration-300"
         x-transition:leave="transition ease-in duration-200">
        <div :class="{
            'bg-green-100 border-green-500 text-green-700': flash.type === 'success',
            'bg-red-100 border-red-500 text-red-700': flash.type === 'error',
            'bg-blue-100 border-blue-500 text-blue-700': flash.type === 'info'
        }" class="border-l-4 p-4 rounded shadow-lg">
            <div class="flex items-center justify-between">
                <p x-text="flash.message"></p>
                <button @click="flash.message = ''" class="ml-4">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="min-h-screen">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    {% include "components/footer.html" %}
    
    <!-- Cart Drawer -->
    {% include "components/cart_drawer.html" %}
    
    <!-- Global Scripts -->
    <script>
        // Cart Store
        document.addEventListener('alpine:init', () => {
            Alpine.store('cart', {
                items: [],
                subtotal: 0,
                itemCount: 0,
                isOpen: false,
                isLoading: false,
                
                async init() {
                    // Load from localStorage for guests
                    const savedCart = localStorage.getItem('guest_cart');
                    if (savedCart) {
                        try {
                            const parsed = JSON.parse(savedCart);
                            this.items = parsed.items || [];
                            this.subtotal = parsed.subtotal || 0;
                            this.itemCount = parsed.itemCount || 0;
                        } catch (e) {
                            console.error('Failed to parse cart:', e);
                        }
                    }
                },
                
                async add(productId, quantity = 1, productData = null) {
                    this.isLoading = true;
                    
                    {% if user %}
                    // Authenticated: use API
                    try {
                        const response = await fetch('/api/cart/items', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: productId, quantity })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.updateFromResponse(data);
                            this.showFlash('Added to cart!', 'success');
                        }
                    } catch (e) {
                        this.showFlash('Failed to add item', 'error');
                    }
                    {% else %}
                    // Guest: use localStorage
                    if (productData) {
                        const existing = this.items.find(i => i.product_id === productId);
                        if (existing) {
                            existing.quantity += quantity;
                            existing.line_total = existing.price * existing.quantity;
                        } else {
                            this.items.push({
                                product_id: productId,
                                ...productData,
                                quantity,
                                line_total: productData.price * quantity
                            });
                        }
                        this.recalculate();
                        this.saveToLocal();
                        this.showFlash('Added to cart!', 'success');
                    }
                    {% endif %}
                    
                    this.isLoading = false;
                },
                
                async updateQuantity(productId, quantity) {
                    this.isLoading = true;
                    
                    {% if user %}
                    try {
                        const response = await fetch(`/api/cart/items/${productId}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ quantity })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.updateFromResponse(data);
                        }
                    } catch (e) {
                        this.showFlash('Failed to update item', 'error');
                    }
                    {% else %}
                    const item = this.items.find(i => i.product_id === productId);
                    if (item) {
                        if (quantity <= 0) {
                            this.items = this.items.filter(i => i.product_id !== productId);
                        } else {
                            item.quantity = quantity;
                            item.line_total = item.price * quantity;
                        }
                        this.recalculate();
                        this.saveToLocal();
                    }
                    {% endif %}
                    
                    this.isLoading = false;
                },
                
                async remove(productId) {
                    this.isLoading = true;
                    
                    {% if user %}
                    try {
                        const response = await fetch(`/api/cart/items/${productId}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.updateFromResponse(data);
                            this.showFlash('Item removed', 'info');
                        }
                    } catch (e) {
                        this.showFlash('Failed to remove item', 'error');
                    }
                    {% else %}
                    this.items = this.items.filter(i => i.product_id !== productId);
                    this.recalculate();
                    this.saveToLocal();
                    this.showFlash('Item removed', 'info');
                    {% endif %}
                    
                    this.isLoading = false;
                },
                
                updateFromResponse(data) {
                    this.items = data.items;
                    this.subtotal = data.subtotal;
                    this.itemCount = data.item_count;
                },
                
                recalculate() {
                    this.subtotal = this.items.reduce((sum, item) => sum + parseFloat(item.line_total), 0);
                    this.itemCount = this.items.reduce((sum, item) => sum + item.quantity, 0);
                },
                
                saveToLocal() {
                    localStorage.setItem('guest_cart', JSON.stringify({
                        items: this.items,
                        subtotal: this.subtotal,
                        itemCount: this.itemCount
                    }));
                },
                
                toggle() {
                    this.isOpen = !this.isOpen;
                },
                
                showFlash(message, type) {
                    Alpine.store('flash', { message, type });
                    setTimeout(() => Alpine.store('flash', { message: '', type: '' }), 3000);
                }
            });
            
            Alpine.store('flash', { message: '', type: '' });
        });
        
        function appState() {
            return {
                flash: { message: '', type: '' },
                
                init() {
                    // Initialize cart
                    Alpine.store('cart').init();
                    
                    // Watch flash store
                    this.$watch('$store.flash', (value) => {
                        this.flash = value;
                    });
                }
            }
        }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
